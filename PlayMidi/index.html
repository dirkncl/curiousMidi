<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <script src="../js/getMidiLyrics.js"></script>    
  </head>
  
  <body>
    
    <script>

      var param = {};
      var isMobile=/Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent)
      window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {param[key] = value;}).replace(/\+/g," ");
      var midi = param.midi;
      var info = param.info;
      var ssTime = param.sstime;
      var charset = param.charset;
      var s_saver = param.saver;
      
      
      var bgr = param.img||"https://4.bp.blogspot.com/-Z4sve3fJ7to/W5DdH1aFU2I/AAAAAAAACd8/MpQG3ZbI-V4g5m7BmCGnnSb-8Dr6pp4jgCLcBGAs/s1600/most-beautiful-waterfall-iceland-seljalandsfoss.jpg";
      bgr = decodeURIComponent(bgr);
      document.body.style = `
          background: url(${bgr}) no-repeat center center fixed; 
          -webkit-background-size: contain;
          -moz-background-size: contain;
          -o-background-size: contain;
          background-size: contain;
          background-color: black;
      `;
       document.body.innerHTML='';  

      
      

      if(midi){
        midi = decodeURIComponent(midi);
        document.title = midi.split("/").pop();
        document.body.innerHTML+='<center><button style="position:fixed;top:0;z-index:10;"><a id="playmidi" style="text-decoration:none">Play</a></button></center>';
        document.getElementById("playmidi").href = midi;
      }
     
      var char_set;
      switch  (charset){
        case "utf8":char_set="utf-8";break;
        case "iso88591":char_set="iso-8859-1";break;
        case "iso88592":char_set="iso-8859-2";break;
        case "iso88593":char_set="iso-8859-3";break;
        case "iso88594":char_set="iso-8859-4";break;
        case "iso88595":char_set="iso-8859-5";break;
        case "iso88596":char_set="iso-8859-6";break;
        case "iso88597":char_set="iso-8859-7";break;
        case "iso88598":char_set="iso-8859-8";break;
      }      
      
      if(info){
        var infoMaxWidth, infoMaxHeight;
        infoMaxWidth="40%";
        infoMaxHeight="70%";
        if(isMobile){
          infoMaxWidth="80%";
          infoMaxHeight="80%";
        }
        (sty=document.createElement("style")).textContent='#info::-webkit-scrollbar {height: 8px;width: 8px;background: #404040;}#info::-webkit-scrollbar-thumb{background: #909090;border-radius: 4ex;}#info ::-webkit-scrollbar-corner{background: #000;}',document.head.appendChild(sty)
        document.body.innerHTML+='<div id="Info" style="position:fixed;max-height:'+infoMaxHeight+';max-width:'+infoMaxWidth+';left:50%;transform: translate(-50%);bottom:1%;z-index:10;overflow-y:auto;overflow-x:visible;background-color:black;opacity:0.7"><center><header style="background-color:blue;color:ivory;"></header></center><article style="color:gold;padding:10px;"></article></div>';
        
        var Text = decodeURIComponent(info);
        var omt = char_set||"utf-8";
        if(Text.includes("file::")){
          Text = Text.split("::")[1];
          var ext = Text.split(".").pop();
          var filename = Text.split("/").pop();
          var fn = filename.replace("."+ext,"");
          function getText(url,cb){
            var result="";
            var xr = new XMLHttpRequest();
            //xr.overrideMimeType("text/plain; charset=iso-8859-1");
             xr.overrideMimeType("text/plain; charset="+omt);
            xr.onload = function() {
              var res =xr.responseText.split("\n");
              for(var i = 0;i<res.length;i++){
                result = result + res[i]+"<br>"
              }
              cb(result)
            };
            xr.open("GET", url, true);
            xr.send();
          }
          var header = fn;
          getText(Text, function(txt){
            var article = txt;
            document.getElementById("Info").getElementsByTagName("header")[0].textContent=header;
            document.getElementById("Info").getElementsByTagName("article")[0].innerHTML=article;
        
          })
        
        }
        else if(Text.includes("::")){
          var header = Text.split('::')[0];
          var artcl = Text.split('::')[1];
          var article = artcl.replace(/\\n/g,"<br>");
        
          document.getElementById("Info").getElementsByTagName("header")[0].textContent=header;
          document.getElementById("Info").getElementsByTagName("article")[0].innerHTML=article;
        }
        
        else if(Text.includes("selflyrics~~")||Text.includes("selflyrics!!")||Text.includes("selflyrics//")){
          Text = Text.replace(RegExp('selflyrics~~'.slice(10),"g"),"")
                     .replace(RegExp('selflyrics!!'.slice(10),"g"),"")
                     .replace(RegExp('selflyrics//'.slice(10),"g"),"");

          midi = decodeURIComponent(midi);
          var header = midi.split("/").pop().replace('.'+midi.split(".").pop(),'');
          var article;          
          GetMidiLyrics(midi,function(data){
            var lyr='';
            var midiFile = new MIDIFile(data);
            var lyrics = midiFile.getLyrics();
            
            for (var idx = 0; idx < lyrics.length; idx++) {
              lyr+=lyrics[idx].text
            }
            if(lyr.length>1){
              article = lyr.replace(/\/\\/g,'').replace(/\\/g,'<br><br>').replace(/\//g,'<br>'); 
              article = Text.replace(/selflyric/g, article);
              document.getElementById("Info").getElementsByTagName("header")[0].textContent=header;
              document.getElementById("Info").getElementsByTagName("article")[0].innerHTML=article;
            }
          })
          
        
        }
      }
      
      if(!midi&&!info){
        alert("How To Use:: PlayMidi.html?midi=midiURL&img=imageURL&info=infoText|infoFileTextURL&saver=ScreenSaverEngine;slideshowTime\n1. midi: midiURL or karURL or rmiURL\n2. img: imageURL - jpg or gif or png\n3. info: infoText - header title :: article linefeed with '\\n' or  infoFileTextURL - file.txt or selflyrics~~ or selflyrics!! selflyrics// get midi lyric if any\n4. saver: screensaver engine. ScreenSaverEngine: makeitdark or shadertoy or screensaver,\nslideshowTime: time for screensaver slideshow transition")
      }
       
      var ifrm=document.createElement("iframe");ifrm.name="iframes";ifrm.frameborder="0";ifrm.setAttribute("frameBorder", "0");ifrm.style=`position:fixed;bottom:0;left:0;max-width:40%;max-height:35px;display:;opacity:0.9`;document.body.appendChild(ifrm);var base="";var a_arr=document.getElementsByTagName("a");var hrefMid=[];var hrefContent=[];var midis=[];for(var i=0;i<a_arr.length;i++){hrefContent[i]=a_arr[i].href;hrefMid[i] = hrefContent[i].split('.').pop();if(hrefMid[i]==="mid"||hrefMid[i]==="MID"||hrefMid[i]==="kar"||hrefMid[i]==="KAR"||hrefMid[i]==="midi"||hrefMid[i]==="MIDI") {midis[i]=hrefContent[i];a_arr[i].target="iframes";a_arr[i].href="../index.html?"+base+midis[i]}else{a_arr[i].target="_blank";};}
    
    </script>  
  
  
  </body>
  
  <script src="../js/ssTrigger.js"></script>
  <script>ssTimer = ssTime
    s_saver=s_saver||"makeitdark;30";
    var ssaver = s_saver.split(";");
    var t = ssaver[1]||"";
    switch (ssaver[0]){
      case "makeitdark" : ssHTML = "../../MakeItDark/index.html?zoomFull=true&ssTime="+t;break;
      case "shadertoy" : ssHTML = "../../ShadertoySaver/index.html?"+t;break;//?zoomFull=true&ssTime=30
      case "screensaver" : ssHTML = "../screensaver/index.html?"+t;break;//?zoomFull=true&ssTime=30
    }
    
     
    
    
  </script>
  
</html>
