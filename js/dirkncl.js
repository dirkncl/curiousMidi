var context,audioBuffer,midiBuffer,midiArray,midiInitClose,IntrumentNumMising,curiousMidiJS="lib/curiousMidi.js",paths="https:/dirkncl.github.io/muki-io/",InputChannel=1,OutputChannel=1,source=0,audioBufferSize=8192,midReadWave=0,song=0,midiStartTime=0,audio_status="";function SciptLoad(e,i){var t=document.getElementsByTagName("script")[0],n=document.createElement("script");n.onload=function(){i()},n.onerror=function(){ConsoleLog("Where your script "+e)},n.src=e,n.type="text/javascript",t.parentNode.insertBefore(n,t)}context=new AudioContext;var midiPlayEvent={};function nextWaveRead(e){if(midiPlayEvent.time=context.currentTime-midiStartTime,midiPlayTime(midiPlayEvent),0!=(midReadWave=cmInterface.midSongReadWave(song,audioBuffer,2*audioBufferSize)))for(var i=0;i<audioBufferSize;i++)i<midReadWave?e.outputBuffer.getChannelData(0)[i]=cmInterface.getValue(audioBuffer+2*i,cmInterface.i32)/cmInterface.i32Max:(ConsoleLog("Filling 0 at end of buffer"),e.outputBuffer.getChannelData(0)[i]=0);else midiStop()}function loadMissingPatch(i,e,t){var n=new XMLHttpRequest;n.open("GET",e+t,!0),n.responseType="arraybuffer",n.onerror=function(){ConsoleLog("Error: patch file none or cannot retrive "+e+t)},n.onload=function(){if(IntrumentNumMising--,cmInterface.createPat(t,cmInterface.buffToArr(n.response)),ConsoleLog("Loading instruments: "+IntrumentNumMising),0==IntrumentNumMising){stream=cmInterface.midIstreamOpenMem(midiBuffer,midiArray.length);var e=cmInterface.midCreateOptions(context.sampleRate,cmInterface.MID_AUDIO_S16LSB,2*audioBufferSize);song=cmInterface.midSongLoad(stream,e),midiInitClose=cmInterface.midIstreamClose(stream),cmInterface.midSongStart(song),source=context.createScriptProcessor(audioBufferSize,InputChannel,OutputChannel),audioBuffer=cmInterface.midMemory(2*audioBufferSize),source.onaudioprocess=nextWaveRead,source.connect(context.destination),midiStartTime=context.currentTime,ConsoleLog("Playing: "+i+" ...")}},n.send()}function midiPlay(e){midiStop();for(var i="",t=0;t<document.scripts.length;t++){document.scripts[t].src;i=curiousMidiJS}for(t=0;t<document.scripts.length;t++){if(i==document.scripts[t].src)return}ConsoleLog("Loading libtimidity ... "),SciptLoad(i,function(){midiFileLoader(e)})}function midiFileLoader(n){ConsoleLog("Loading MIDI file "+n+" ...");var r=new XMLHttpRequest;r.open("GET",n,!0),r.responseType="arraybuffer",r.onerror=function(){ConsoleLog("Error: Cannot retrieve MIDI file "+n)},r.onload=function(){ConsoleLog("MIDI file loaded: "+n),midiArray=cmInterface.buffToArr(r.response),midiBuffer=cmInterface.midMemory(midiArray.length),cmInterface.midToMemory(midiArray,midiBuffer),midiInitClose=cmInterface.midInit(),stream=cmInterface.midIstreamOpenMem(midiBuffer,midiArray.length);var e=cmInterface.midCreateOptions(context.sampleRate,cmInterface.MID_AUDIO_S16LSB,2*audioBufferSize);if(song=cmInterface.midSongLoad(stream,e),midiInitClose=cmInterface.midIstreamClose(stream),0<(IntrumentNumMising=cmInterface.midSongGetNumMissingInstruments(song)))for(var i=0;i<IntrumentNumMising;i++){var t=cmInterface.midSongGetMissingInstrument(song,i);loadMissingPatch(n,paths+"pat/",t)}else cmInterface.midSongStart(song),source=context.createScriptProcessor(audioBufferSize,InputChannel,OutputChannel),audioBuffer=cmInterface.midMemory(2*audioBufferSize),source.onaudioprocess=nextWaveRead,source.connect(context.destination),midiStartTime=context.currentTime,ConsoleLog("Playing: "+n+" ...")},r.send()}function midiStop(){source&&(source.disconnect(),source.onaudioprocess=0,source=0,cmInterface.midFreeMemory(audioBuffer),cmInterface.midFreeMemory(midiBuffer),cmInterface.midSongFree(song),song=0,cmInterface.midExit(),source=0),midiPlayEvent.time=0,midiPlayTime(midiPlayEvent)}var ConsoleLog=function(e){console.log(e)},midiPlayTime=function(e){},get_audio_status=function(){return audio_status};function include(e){var i=document.getElementsByTagName("script")[0],t=document.createElement("script");t.onerror=function(){ConsoleLog("Where your script "+e)},t.src=e,t.type="text/javascript",i.parentNode.insertBefore(t,i)}include("js/interface.js");var ls=location.search,par="";-1!=(par=decodeURIComponent(ls).replace(/\+/g," ").replace("?","")).indexOf("&")&&((par=par.split("&"))[1]="",par=par[0]),""!=par&&midiPlay(par);