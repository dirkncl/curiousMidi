var context,audioBuffer,midiBuffer,midiArray,midiInitClose,IntrumentNumMising,cookies={set:function(e,n,t){var o="";if(t){var r=new Date;r.setTime(r.getTime()+24*t*60*60*1e3),o="; expires="+r.toGMTString()}document.cookie=e+"="+n+o+"; path=/"},get:function(e){for(var n=e+"=",t=document.cookie.split(";"),o=0;o<t.length;o++){for(var r=t[o];" "==r.charAt(0);)r=r.substring(1,r.length);if(0==r.indexOf(n))return r.substring(n.length,r.length)}},del:function(e){this.set(e,"",-1)}},SoundsOutput=function(){function e(e,n){var t="[Output] "+e;return arguments[0]=t,console.log.apply(console,arguments)}function n(){var e=Object.keys(u),n=e[e.length-1];return u[n]}function t(e,t){n().connect(t),u[e]=t}function o(n){var t=new Uint8Array(u.analyser_before.frequencyBinCount);u.analyser_before.getByteFrequencyData(t);var o=new Uint8Array(u.analyser_after.frequencyBinCount);u.analyser_after.getByteFrequencyData(o);for(var r=0,i=0,a=t.length,c=0;a>c;c++)r+=t[c],i+=o[c];var s=r/a,m=i/a;e("Average volume before / after -> difference ",s,m,s-m),e("Reduction: ",u.compressor.reduction.value.toFixed(2))}function r(e){e.connect(s)}function i(e){return void 0===e||e>1||0>e?console.log("Invalid volume!",e):(cookies.set("volume",e),void(u.gain.gain.value=e))}var a,c,s,u={},m=!0,d=!1,f=.8;return{setup:function(e){a=e;var i,l=cookies.get("volume");return c=l?parseFloat(l):f,s=u.gain=a.createGain(),u.gain.gain.value=c,d&&((i=a.createAnalyser()).smoothingTimeConstant=.2,i.fftSize=2048,t("analyser_before",i)),m&&t("compressor",a.createDynamicsCompressor()),d&&((i=a.createAnalyser()).smoothingTimeConstant=.2,i.fftSize=2048,t("analyser_after",i),setInterval(o,200)),n().connect(a.destination),s.receive=r,s},set_vol:i,decrease_vol:function(){.01>=c||i(c-=.05)},increase_vol:function(){c>=1.01||i(c+=.05)},current_vol:function(){return u.gain.gain.value},toggle_compressor:function(){if(u.compressor)e("Disabling DynamicsCompressor."),u.compressor.disconnect(),delete u.compressor,n().connect(a.destination);else{e("Enabling DynamicsCompressor.");var t=n();t.disconnect(),u.compressor=a.createDynamicsCompressor(),t.connect(u.compressor),u.compressor.connect(a.destination)}}}}(),curiousMidiJS="lib/curiousMidi.js",paths="../muki-io/",InputChannel=1,OutputChannel=2,source=0,audioBufferSize=Math.pow(2,13),midReadWave=0,song=0,midiStartTime=0,audio_status="";context=new AudioContext;var gain,soundvol=SoundsOutput.setup(context),L=2,gainValue=1;SoundsOutput.set_vol(.8);var KeyState=!1;document.addEventListener("keydown",function(e){if(27==e.keyCode||!KeyState&&!e.metaKey)switch(e.ctrlKey){case!1:switch(e.keyCode){case 32:e.preventDefault(),midiStop();break;case 38:e.preventDefault(),SoundsOutput.increase_vol(),console.log(SoundsOutput.current_vol());break;case 40:e.preventDefault(),SoundsOutput.decrease_vol(),console.log(SoundsOutput.current_vol())}break;case!0:switch(e.keyCode){case 67:e.preventDefault(),SoundsOutput.toggle_compressor()}}});var loadFileTextStore=[];function loadFileText(e,n){if(!loadFileTextStore.includes(e)){var t=new XMLHttpRequest;t.overrideMimeType("text/plain; charset=utf-8"),t.open("GET",e,!0),t.onload=function(){var e=t.responseText;eval.apply(window,[e]),n()},t.send(null)}}function SciptLoad(e,n){var t=document.getElementsByTagName("script")[0],o=document.createElement("script");o.onload=function(){n()},o.onerror=function(){ConsoleLog("Where your script "+e)},o.src=e,o.type="text/javascript",t.parentNode.insertBefore(o,t)}var midiPlayEvent={};function nextWaveRead(e){if(midiPlayEvent.time=context.currentTime-midiStartTime,midiPlayTime(midiPlayEvent),0!=(midReadWave=cmInterface.midSongReadWave(song,audioBuffer,2*audioBufferSize)))for(var n=0;n<audioBufferSize;n++)if(n<midReadWave)for(var t=0;L>t;t++)e.outputBuffer.getChannelData(t)[n]=cmInterface.getValue(audioBuffer+2*n,cmInterface.i32)/cmInterface.i32Max;else{/*ConsoleLog("Filling 0 at end of buffer");for(t=0;L>t;t++)e.outputBuffer.getChannelData(t)[n]=0*/}else midiStop()}function loadMissingPatch(e,n,t){var o=new XMLHttpRequest;o.open("GET",n+t,!0),o.responseType="arraybuffer",o.onerror=function(){ConsoleLog("Error: patch file none or cannot retrive "+n+t)},o.onload=function(){if(IntrumentNumMising--,cmInterface.createPat(t,cmInterface.buffToArr(o.response)),ConsoleLog("Loading instruments: "+IntrumentNumMising),0==IntrumentNumMising){stream=cmInterface.midIstreamOpenMem(midiBuffer,midiArray.length);var n=cmInterface.midCreateOptions(context.sampleRate,cmInterface.MID_AUDIO_S16LSB,2*audioBufferSize);song=cmInterface.midSongLoad(stream,n),midiInitClose=cmInterface.midIstreamClose(stream),cmInterface.midSongStart(song),source=context.createScriptProcessor(audioBufferSize,InputChannel,OutputChannel),audioBuffer=cmInterface.midMemory(2*audioBufferSize),source.onaudioprocess=nextWaveRead;var r=context.createGain();r.gain.value=gainValue,source.connect(r),r.connect(soundvol),midiStartTime=context.currentTime,ConsoleLog("Playing: "+e+" ...")}},o.send()}function midiPlay(e){context.resume().then(()=>{console.log("Playback resumed successfully")}),midiStop();var n=curiousMidiJS;ConsoleLog("Loading curiousMidi ... "),loadFileText(n,function(){midiFileLoader(e)})}function midiFileLoader(e){ConsoleLog("Loading MIDI file "+e+" ...");var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="arraybuffer",n.onerror=function(){ConsoleLog("Error: Cannot retrieve MIDI file "+e)},n.onload=function(){ConsoleLog("MIDI file loaded: "+e),midiArray=cmInterface.buffToArr(n.response),midiBuffer=cmInterface.midMemory(midiArray.length),cmInterface.midToMemory(midiArray,midiBuffer),midiInitClose=cmInterface.midInit(),stream=cmInterface.midIstreamOpenMem(midiBuffer,midiArray.length);var t=cmInterface.midCreateOptions(context.sampleRate,cmInterface.MID_AUDIO_S16LSB,2*audioBufferSize);if(song=cmInterface.midSongLoad(stream,t),midiInitClose=cmInterface.midIstreamClose(stream),0<(IntrumentNumMising=cmInterface.midSongGetNumMissingInstruments(song)))for(var o=0;o<IntrumentNumMising;o++){var r=cmInterface.midSongGetMissingInstrument(song,o);loadMissingPatch(e,paths+"pat/",r)}else{cmInterface.midSongStart(song),source=context.createScriptProcessor(audioBufferSize,InputChannel,OutputChannel),audioBuffer=cmInterface.midMemory(2*audioBufferSize),source.onaudioprocess=nextWaveRead;var i=context.createGain();i.gain.value=gainValue,source.connect(i),i.connect(soundvol),midiStartTime=context.currentTime,ConsoleLog("Playing: "+e+" ...")}},n.send()}function midiStop(){source&&(source.disconnect(),source.onaudioprocess=0,source=0,cmInterface.midFreeMemory(audioBuffer),cmInterface.midFreeMemory(midiBuffer),cmInterface.midSongFree(song),song=0,cmInterface.midExit(),source=0),midiPlayEvent.time=0,midiPlayTime(midiPlayEvent)}var ConsoleLog=function(e){console.log(),console.log(e)},midiPlayTime=function(e){},get_audio_status=function(){return audio_status},includeStore=[];function include(e){if(!includeStore.includes(e)){var n=new XMLHttpRequest;n.overrideMimeType("text/plain; charset=utf-8"),n.open("GET",e,!0),n.onload=function(){4===n.readyState&&(200!==n.status&&0!=n.status||eval.apply(window,[n.responseText]))},n.send(null)}}include("js/interface.js");var ls=location.search,par="";-1!=(par=decodeURIComponent(ls).replace(/\+/g," ").replace("?","")).indexOf("&")&&((par=par.split("&"))[1]="",par=par[0]),""!=par&&midiPlay(par);
